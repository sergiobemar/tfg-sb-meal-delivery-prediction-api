<h1>Config Clickhouse server machine</h1>

<h2>Steps</h2>

- [1. Install components for the server](#1-install-components-for-the-server)
- [2. Set SSH keys in GitHub and clone repository](#2-set-ssh-keys-in-github-and-clone-repository)
- [3. Activate Python virtual environment](#3-activate-python-virtual-environment)
- [4. Install libraries for the first time](#4-install-libraries-for-the-first-time)
- [5. Install Docker](#5-install-docker)
- [6. Clickhouse initial configuration](#6-clickhouse-initial-configuration)

### 1. Install components for the server

For this server it's used a Ubuntu machine v18.04 LTS with 2 CPUs and 4 GB of memory, besides its estimated cost is $27,31 in europe-west1 region, if machine was always on.

```
# update system packages and install the required packages
sudo apt-get update
sudo apt-get install bzip2 libxml2-dev libsm6 libxrender1 libfontconfig1 git
sudo apt-get install python3-pip python3-dev build-essential libssl-dev libffi-dev python3-setuptools
sudo apt install python3-venv
```

### 2. Set SSH keys in GitHub and clone repository

```
ssh-keygen -t rsa -b 4096 -C "youremail@email.com"

cat .ssh/id_rsa.pub
```

```
git config --global user.email "you@example.com"
git config --global user.name "Your Name"

# clone the project repo
git clone git@github.com:sergiobemar/tfg-sb-meal-delivery-prediction-api.git
```

### 3. Activate Python virtual environment

```
cd tfg-sb-meal-delivery-prediction-api/clickhouse

python3 -m venv env

source env/bin/activate
```

### 4. Install libraries for the first time

```
pip3 install clickhouse_driver pandas

```

### 5. Install Docker

To install Docker it's possible following [this tutorial](https://www.digitalocean.com/community/tutorials/como-instalar-y-usar-docker-en-ubuntu-18-04-1-es):

```
sudo apt install apt-transport-https ca-certificates curl software-properties-common

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
sudo apt update

apt-cache policy docker-ce
sudo apt install docker-ce

sudo systemctl status docker
```

Then, current user is added to *docker* group.

```
sudo usermod -aG docker ${USER}
```

Now, you have to close the session on the server, so you can restart it or write the following command:

```
su - ${USER}
```

After that, you can check that your user is in Docker group.

```
id -nG
```

### 6. Clickhouse initial configuration 

docker run ./custom_config.xml:/etc/clickhouse-server/config.d/custom_config.xml ./users.xml:/etc/clickhouse-server/users.xml

In order to store the data into a database, it's choosen Clickhouse as OLAP System. Before Clickhouse is launched by Docker, it's needed to create two configuration files which are coding using *XML*.

+ ```users.xml``` : this file provides the user's custom configuration such as quotas, networks settings or profiles. In this case, only password is set using the tag ```password_sha256_hex``` so that save it encrypted. The command used to get the hash of the password choosen is the following:

	```
	PASSWORD=$(base64 < /dev/urandom | head -c8); echo "$PASSWORD"; echo -n "$PASSWORD" | sha256sum | tr -d '-'
	```

	Here there is an example how using the password *test*, the hash of it is generated by the command which would be included in ```users.xml``` file.

	![Clickhouse - Example getting password hash using bash](images/clickhouse/1.0-password-generation-command.png)

	So, the hashed password will be included in ```users.xml``` like:

	```
	<yandex>
		<users>
			<my_user>
				<password_sha256_hex>9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08 </password_sha256_hex>	
			</my_user>
		</users>
	</yandex>
	```
+ ```custom_config.xml``` : overwrites the default Clickhouse config file adding the changes that you want to modify. In order to allow to connect from another host it's changed ```listen_host``` tag:

	```
	<yandex>
        <listen_host>0.0.0.0</listen_host>
	</yandex>
	```